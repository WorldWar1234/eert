import fetch from"node-fetch";import lodash from"lodash";import{generateRandomIP,randomUserAgent}from"./user.js";import{copyHeaders as copyHdrs}from"./copyh.js";import{compressImg as applyCompression}from"./comp.js";import{bypass as performBypass}from"./byp.js";import{redirect as handleRedirect}from"./rrd.js";import{shouldCompress as checkCompression}from"./scomp.js";const viaHeaders=["1.1 example-proxy-service.com (ExampleProxy/1.0)","1.0 another-proxy.net (Proxy/2.0)","1.1 different-proxy-system.org (DifferentProxy/3.1)","1.1 some-proxy.com (GenericProxy/4.0)"];function randomVia(){var r=Math.floor(Math.random()*viaHeaders.length);return viaHeaders[r]}async function processRequest(e,o){var{url:r,jpeg:a,bw:s,l:t}=e.query;if(!r)return p=generateRandomIP(),n=randomUserAgent(),p={...lodash.pick(e.headers,["cookie","dnt","referer"]),"x-forwarded-for":p,"user-agent":n,via:randomVia()},Object.entries(p).forEach(([r,e])=>o.header(r,e)),o.send("1we23");var n=(Array.isArray(r)?r.join("&url="):r).replace(/http:\/\/1\.1\.\d\.\d\/bmi\/(https?:\/\/)?/i,"http://"),p=(e.params.url=n,e.params.webp=!a,e.params.grayscale="0"!==s,e.params.quality=parseInt(t,10)||40,generateRandomIP()),r=randomUserAgent();try{var m,i=await fetch(e.params.url,{headers:{...lodash.pick(e.headers,["cookie","dnt","referer"]),"user-agent":r,"x-forwarded-for":p,via:randomVia()},timeout:1e4,follow:5,compress:!0});return i.ok?(m=await i.buffer(),copyHdrs(i,o),o.header("content-encoding","identity"),e.params.originType=i.headers.get("content-type")||"",e.params.originSize=m.length,(checkCompression(e)?applyCompression:performBypass)(e,o,m)):handleRedirect(e,o)}catch(r){return handleRedirect(e,o)}}export{processRequest};
